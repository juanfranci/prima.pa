define("odsp-next/dataSources/restore/odc/RestoreOperationDataSource",["require","exports","@ms/odsp-graph/lib/Models","@ms/odsp-utilities/lib/resources/Resources","../../../resources/DataSourceResourceKeys","../../base/vroom/VroomDataRequestor","../IRestoreOperationDataSource","../../restoreActivities/odc/RequestFactsHelper"],function(e,t,n,r,i,s,o,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=(function(){function e(e,t){this._dataRequestor=t.vroomDataRequestor;this._urlDataSource=t.urlDataSource}e.prototype.getOngoingRestoreOperation=function(e){e.headers=this._addRequestFactsHeader(e&&e.headers);return this._dataRequestor.send({apiName:"Operations",headers:e&&e.headers,path:this._urlDataSource.getApiBaseUrl()+"/drive/operations?$filter=type eq 'pointInTimeRestore'&$orderby=createdDateTime desc&$top=1"}).then(function(e){var t=e.value;return 0===t.length?null:{percentComplete:t[0].percentComplete,status:{cancelled:o.RestoreStatus.Cancelled,completed:o.RestoreStatus.Completed,failed:o.RestoreStatus.Failed,notstarted:o.RestoreStatus.NotStarted,inprogress:o.RestoreStatus.InProgress}[t[0].status.toLowerCase()]}},function(e){if(n.isGraphError(e)&&404===e.status)return null;throw e})};e.prototype.submitRestore=function(e){e.headers=this._addRequestFactsHeader(e&&e.headers);var t=JSON.stringify({anomalyId:e.anomalyId,restoreToDateTime:e.dateTime,mostRecentActivityId:e.mostRecentActivityId});return this._dataRequestor.send({apiName:"RestoreToDate",requestType:"POST",headers:e&&e.headers,path:this._urlDataSource.getApiBaseUrl()+"/drive/root/oneDrive.restoreToDate",postData:t,parseResponse:function(e){return{id:JSON.parse(e.responseText).id,resourceLocation:e.getResponseHeader("Location")}}})};e.prototype.isOneDrive=function(){return!0};e.prototype.getQosPrefix=function(){return""};e.prototype._addRequestFactsHeader=function(e){return u.default(e)};e.dependencies={vroomDataRequestor:s.resourceKey,urlDataSource:i.url};return e})();t.RestoreOperationDataSource=a;t.resourceKey=r.createResolvedResourceKey(e("module").id,a)});
define("@ms/odsp-graph/lib/Models",["require","exports","tslib","./models/error/Error"],function(e,t,n,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});n.__exportStar(r,t)});
define("odsp-next/dataSources/restoreActivities/odc/RequestFactsHelper",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=function(e){var t;if(e){e.RequestFacts="scenario=PointInTimeRestore";return e}return(t={}).RequestFacts="scenario=PointInTimeRestore",t}});
define("odsp-next/dataSources/restoreActivities/odc/RestoreActivitiesDataSource",["require","exports","@ms/odsp-utilities/lib/async/Promise","@ms/odsp-utilities/lib/resources/Resources","../../base/vroom/VroomDataRequestor","../../../resources/DataSourceResourceKeys","../../../resources/ProviderResourceKeys","../../itemActivities/index","../RestoreActivities.resx","../../../providers/premium/PremiumStateProvider.key","./DayLightSavingTimeHelper","../../../utilities/features/Features","./RequestFactsHelper"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p=(function(){function e(e,t){void 0===e&&(e={});this._pageSize=200;this._dataRequestor=t.vroomDataRequestor;this._itemActivitiesService=t.itemActivitiesService;this._premiumStateProvider=t.premiumStateProvider;this._urlDataSource=t.urlDataSource;this._userInfoProvider=t.userInfoProvider}e.prototype.getActivities=function(e){var t=this;e.headers=this._addRequestFactsHeader(e&&e.headers);return this._getRootDriveItem().then(function(n){return t._itemActivitiesService.getItemActivities({filter:"create ne null or move ne null or rename ne null or delete ne null or edit ne null or copy ne null or restore ne null",orderBy:"activityDateTime "+(e.sortAscending?"asc":"desc"),item:n,headers:e.headers,pageSize:t._pageSize,nextRequestToken:e.nextRequestToken,environment:"consumer"})})};e.prototype.getActivitiesOnSpecificDate=function(e){var t=this;e.headers=this._addRequestFactsHeader(e&&e.headers);var n="(create ne null or move ne null or rename ne null or delete ne null or edit ne null or copy ne null or restore ne null) and"+(e.sortAscending?" activityDateTime ge "+e.startDateTime.toISOString():" activityDateTime le "+e.startDateTime.toISOString());return this._getRootDriveItem().then(function(r){return t._itemActivitiesService.getItemActivities({filter:n,orderBy:"activityDateTime "+(e.sortAscending?"asc":"desc"),item:r,headers:e.headers,pageSize:t._pageSize,environment:"consumer"})})};e.prototype.getActivitiesByDate=function(e){var t=this;e.headers=this._addRequestFactsHeader(e&&e.headers);return this._getRootDriveItem().then(function(n){if(c.isFeatureEnabled(c.RestoreDSTAdjustment)){return new l.default(t._itemActivitiesService,t._getActivitiesByDate).getActivitiesByDate(e,n)}return t._getActivitiesByDate(t._itemActivitiesService,e,n)})};e.prototype.getActivityOffsetFromDateTime=function(e){var t=this;return this._getRootDriveItem().then(function(n){return t._itemActivitiesService.getActivitiesByInterval({interval:"day",item:n,startDateTime:e,headers:t._addRequestFactsHeader()})}).then(function(e){return e.activitiesByInterval.reduce(function(e,t){return e+(t.totalCount||0)},0)})};e.prototype.getPointsOfInterest=function(e,t){var n=this;e.headers=this._addRequestFactsHeader(e&&e.headers);return this._getRootDriveItem().then(function(r){var i="pointOfInterest ne null and activityDateTime ge "+t.toISOString(),s=r.graphItemUrl+"/activities?$filter="+i;return n._dataRequestor.send({apiName:"ActivitiesPointOfInterest",headers:e.headers,path:s})}).then(function(e){return e.value.map(function(e){return{id:e.id,time:new Date(e.activityDateTime),isPointInTimeRestore:e.pointOfInterest&&"pointInTimeRestore"in e.pointOfInterest,isRansomware:e.pointOfInterest&&(0===Object.keys(e.pointOfInterest).length||"ransomware"in e.pointOfInterest)}})})};e.prototype.getLibraryTitle=function(){return a.default.yourOneDrive};e.prototype.getCombinedSiteLibraryTitle=function(){return this.getLibraryTitle()};e.prototype.isOneDrive=function(){return!0};e.prototype.getQosPrefix=function(){return this.getScenarioName()+".Restore"};e.prototype.getScenarioName=function(){return"OneDrive"};e.prototype.isPremiumUser=function(){return this._premiumStateProvider.getPremiumState(!1).then(function(e){return 3===e})};e.prototype.isEligibleForFreemium=function(){return this._userInfoProvider.hasUserFact(50)};e.prototype.getRestoreEligibility=function(){var e=this;return this.isPremiumUser().then(function(t){return t?n.default.resolve(1):e.isEligibleForFreemium().then(function(e){return e?n.default.resolve(2):n.default.resolve(3)})})};e.prototype.isRestoreSupported=function(){return n.default.resolve({isRestoreSupported:!0})};e.prototype._getRootDriveItem=function(){return n.default.resolve({name:"root",graphItemUrl:this._urlDataSource.getApiBaseUrl()+"/drive/root"})};e.prototype._getActivitiesByDate=function(e,t,n){return e.getActivitiesByDate({item:n,headers:t.headers,startDateTime:t.startDateTime,endDateTime:t.endDateTime,environment:"consumer"})};e.prototype._addRequestFactsHeader=function(e){return h.default(e)};e.dependencies={itemActivitiesService:u.itemActivitiesServiceKey,premiumStateProvider:f.resourceKey,urlDataSource:s.url,userInfoProvider:o.userInfo,vroomDataRequestor:i.resourceKey};return e})();t.default=p;t.resourceKey=r.createResolvedResourceKey(e("module").id,p)});
define("odsp-next/dataSources/itemActivities/index",["require","exports","tslib","@ms/odsp-graph/lib/services/itemActivities/index","./vroom/ItemActivitiesResultProcessor","./vroom/ItemActivitiesService"],function(e,t,n,r,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});n.__exportStar(r,t);t.itemActivitiesResultProcessorKey=i.resourceKey;t.ItemActivitiesService=s.ItemActivitiesService;t.itemActivitiesServiceKey=s.resourceKey});
define("@ms/odsp-graph/lib/services/itemActivities/index",["require","exports","./types","./ItemActivitiesResultProcessor","./ItemActivitiesService"],function(e,t,n,r,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ItemActivityType=n.ItemActivityType;t.matchActivity=n.matchActivity;t.ItemActivitiesResultProcessor=r.default;t.ItemActivitiesService=i.default});
define("@ms/odsp-graph/lib/services/itemActivities/ItemActivitiesService",["require","exports","@ms/odsp-utilities/lib/async/Promise"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.DEFAULT_PAGE_SIZE=25;var r={folderDoesNotExist:!0,itemNotFound:!0,accessDenied:!0,unauthenticated:!0},i=(function(){function e(e,t){this._dataRequestor=t.vroomDataRequestor;this._itemActivitiesResultProcessor=t.itemActivitiesResultProcessor}e.prototype.getItemActivities=function(e){var t=this;e.environment=e.environment||"sharePoint";if(e.mockData)return n.default.resolve({activities:e.mockData,isPlaceholder:!1,success:!0});var i=this._getRequestUrl(e);return this._dataRequestor.send({apiName:e.qosPrefix?e.qosPrefix+".GetItemActivities":"GetItemActivities",path:i,headers:e.headers,accessToken:e.item.accessToken,apiVersion:e.apiVersion,expectedErrorCodes:r}).then(function(n){return t._itemActivitiesResultProcessor.processResponse({item:e.item,response:n})},function(e){return{error:e,isPlaceholder:!1,activities:[],success:!1}})};e.prototype.getActivitiesByDate=function(e){e.environment=e.environment||"sharePoint";return e.mockData?n.default.resolve({activitiesByDate:e.mockData,success:!0}):this.getActivitiesByInterval({item:e.item,headers:e.headers,interval:"day",startDateTime:e.startDateTime,endDateTime:e.endDateTime}).then(function(e){return{error:e.error,success:e.success,activitiesByDate:e.activitiesByInterval.map(function(e){var t=e.startDateTime;return{createCount:e.createCount,deleteCount:e.deleteCount,editCount:e.editCount,moveCount:e.moveCount,restoreCount:e.restoreCount,copyCount:e.copyCount,totalCount:e.totalCount,date:s(t)}})}},function(e){return n.default.resolve({activitiesByDate:[],error:new Error("Not implemented"),success:!1})})};e.prototype.getActivitiesByInterval=function(e){var t=this,n=e.endDateTime?"&endDateTime="+e.endDateTime.toISOString():"",r=e.item.graphItemUrl+"/action.getActivitiesByInterval?startDateTime="+e.startDateTime.toISOString()+"&interval=day"+n;return this._dataRequestor.send({apiName:"GetActivitiesByInterval",headers:e.headers,path:r}).then(function(e){return t._itemActivitiesResultProcessor.processActivitiesByIntervalResponse(e)},function(e){return{error:e,activitiesByInterval:[],success:!1}})};e.prototype._getRequestUrl=function(e){var n=e.pageSize?e.pageSize:t.DEFAULT_PAGE_SIZE,r=e.item.graphItemUrl+"/activities?$expand=driveItem($select=id,name,webUrl,parentReference,file,folder)";r+="&$top="+n;e.filter&&(r+="&$filter="+e.filter);e.orderBy&&(r+="&$orderby="+e.orderBy);e.nextRequestToken&&(r+="&$skiptoken="+e.nextRequestToken);return r};return e})();t.default=i;function s(e){function t(e){return e<10?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())}});
define("odsp-next/dataSources/itemActivities/vroom/ItemActivitiesService",["require","exports","@ms/odsp-utilities/lib/resources/Resources","../../base/vroom/VroomDataRequestor","@ms/odsp-graph/lib/services/itemActivities/index","./ItemActivitiesResultProcessor"],function(e,t,n,r,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.ItemActivitiesService=i.ItemActivitiesService;t.resourceKey=n.createResolvedResourceKey(e("module").id,i.ItemActivitiesService,{vroomDataRequestor:r.resourceKey,itemActivitiesResultProcessor:s.resourceKey})});
define("odsp-next/providers/premium/PremiumStateProvider.key",["require","exports","@ms/odsp-utilities/lib/resources/Resources"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.resourceKey=new n.ResourceKey({name:e("module").id,loader:new n.AliasResourceLoader(function(){return new Promise(function(t,n){e(["./PremiumStateProvider"],t,n)}).then(function(e){return e.resourceKey})})})});
define("odsp-next/dataSources/restoreActivities/odc/DayLightSavingTimeHelper",["require","exports","tslib","@ms/odsp-utilities/lib/logging/ErrorHelper","@ms/odsp-utilities/lib/async/Promise"],function(e,t,n,r,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=(function(){function e(e,t){this._itemActivitiesService=e;this._getActivities=t}e.prototype.getActivitiesByDate=function(e,t){try{var n=this._findDayAfterDST(e);if(n)return this._getActivitiesWithDSTAdjustment(e,t,n)}catch(e){r.default.logError(e)}return this._getActivities(this._itemActivitiesService,e,t)};e.prototype._findDayAfterDST=function(e){var t=e.startDateTime,n=e.endDateTime||new Date,r=n.getTimezoneOffset();if(r!==t.getTimezoneOffset())for(var i=t;i<n;i=new Date(i.getFullYear(),i.getMonth(),i.getDate()+1))if(r===i.getTimezoneOffset())return i};e.prototype._getActivitiesWithDSTAdjustment=function(e,t,r){var s=this,o=[];o.push(this._getActivities(this._itemActivitiesService,n.__assign(n.__assign({},e),{endDateTime:r}),t));o.push(this._getActivities(this._itemActivitiesService,n.__assign(n.__assign({},e),{startDateTime:r}),t));return i.default.all(o).then(function(e){return s._mergeActivities(e)})};e.prototype._mergeActivities=function(e){for(var t=0;t<e.length;t++)if(e[t].error)return e[t];var r=e[0].activitiesByDate;for(t=1;t<e.length;t++)r=e[t].activitiesByDate.concat(r);for(t=1;t<r.length;t++)if(r[t-1].date===r[t].date){var i=(r[t-1].totalCount?r[t-1].totalCount:0)+(r[t].totalCount?r[t].totalCount:0);r[t-1]=n.__assign(n.__assign({},r[t-1]),{totalCount:i});r.splice(t,1);break}return{activitiesByDate:r,success:!0}};return e})();t.default=s});
define("odsp-next/providers/premium/PremiumStateProvider",["require","exports","tslib","../../resources/ProviderResourceKeys","@ms/odsp-utilities/lib/resources/Resources","@ms/odsp-shared/lib/base/BaseModel"],function(e,t,n,r,i,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=(function(e){n.__extends(t,e);function t(t,n){void 0===t&&(t={});var r=e.call(this,t,n)||this;r._userInfoProvider=n.userInfoProvider;r._storageOptionsProvider=n.storageOptionsProvider;r._userStateProvider=n.userStateProvider;return r}t.prototype.getPremiumState=function(e){return this._checkHasOffice(e).then(function(e){return null==e?0:e?3:2})};t.prototype._checkHasOffice=function(e){var t=this;return this._userInfoProvider.getIsPremium(e).then(function(e){return e},function(n){return t._storageOptionsProvider.getHasCurrentOfficePlan(e).then(function(e){return e},function(e){t._userStateProvider=t.resources.consume(r.quota.optional);if(t._userStateProvider)return t._userStateProvider.total.peek()>=1099511627776})})};t.dependencies=n.__assign(n.__assign({},s.default.dependencies),{userStateProvider:r.quota.optional,userInfoProvider:r.userInfo,storageOptionsProvider:r.storageOptions});return t})(s.default);t.default=o;t.resourceKey=i.createResolvedResourceKey(e("module").id,o)});